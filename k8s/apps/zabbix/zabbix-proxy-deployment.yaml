# Zabbix Proxy Deployment
# Proxy para monitoramento distribuído com MySQL/MariaDB
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zabbix-proxy
  namespace: zabbix
  labels:
    app: zabbix
    component: proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zabbix
      component: proxy
  template:
    metadata:
      labels:
        app: zabbix
        component: proxy
    spec:
      securityContext:
        runAsUser: 1997
        runAsGroup: 1995
        fsGroup: 1995

      # Init container para corrigir permissões
      initContainers:
        - name: fix-permissions
          image: busybox:1.36
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              mkdir -p /var/lib/zabbix/proxy
              chown -R 1997:1995 /var/lib/zabbix
              chmod -R 775 /var/lib/zabbix
          volumeMounts:
            - name: zabbix-proxy-data
              mountPath: /var/lib/zabbix

      containers:
        - name: zabbix-proxy
          image: zabbix/zabbix-proxy-mysql:ubuntu-7.4.5
          ports:
            - containerPort: 10051
              name: proxy-trapper
              protocol: TCP
          env:
            # Zabbix Server Connection
            - name: ZBX_SERVER_HOST
              value: "zabbix-server.zabbix.svc.cluster.local"
            - name: ZBX_SERVER_PORT
              value: "10051"

            # Proxy Configuration
            - name: ZBX_HOSTNAME
              value: "zabbix-proxy-k8s"
            - name: ZBX_PROXYMODE
              value: "0" # 0=active, 1=passive

            # MySQL/MariaDB Database (proxy local)
            - name: DB_SERVER_HOST
              value: "mariadb.mariadb.svc.cluster.local"
            - name: DB_SERVER_PORT
              value: "3306"
            - name: MYSQL_USER
              value: "root"
            - name: MYSQL_PASSWORD
              value: "mariadb_root"
            - name: MYSQL_DATABASE
              value: "zabbix_proxy"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: zabbix-db-secret
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              value: "zabbix_proxy"

            # Proxy Tuning
            - name: ZBX_CONFIGFREQUENCY
              value: "60" # Sync config every 60s
            - name: ZBX_DATASENDERFREQUENCY
              value: "1" # Send data every 1s
            - name: ZBX_STARTPOLLERS
              value: "5"
            - name: ZBX_STARTTRAPPERS
              value: "5"
            - name: ZBX_STARTPINGERS
              value: "1"
            - name: ZBX_STARTDISCOVERERS
              value: "1"
            - name: ZBX_STARTHTTPPOLLERS
              value: "1"

            # Cache Configuration
            - name: ZBX_CACHESIZE
              value: "64M"
            - name: ZBX_HISTORYCACHESIZE
              value: "32M"

            # Timeout
            - name: ZBX_TIMEOUT
              value: "10"
            - name: ZBX_DEBUGLEVEL
              value: "3"

          livenessProbe:
            tcpSocket:
              port: 10051
            initialDelaySeconds: 30
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            tcpSocket:
              port: 10051
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"

          volumeMounts:
            - name: zabbix-proxy-data
              mountPath: /var/lib/zabbix
              subPath: proxy

      volumes:
        - name: zabbix-proxy-data
          persistentVolumeClaim:
            claimName: zabbix-proxy-pvc

---
# Zabbix Proxy Service
apiVersion: v1
kind: Service
metadata:
  name: zabbix-proxy
  namespace: zabbix
  labels:
    app: zabbix
    component: proxy
spec:
  type: ClusterIP
  selector:
    app: zabbix
    component: proxy
  ports:
    - port: 10051
      targetPort: 10051
      protocol: TCP
      name: proxy-trapper
